{% extends "FinancialReporting/index.html" %}
{% load tr_month %}
{% load generic %}

{% block content %}

<p>
  <a href="{% url 'presencedata_view' %}" aria-label="Back" class="btn btn-default"><span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span> Back</a>
</p>
<p>
  Total hours: {{ total_hours | floatformat:-1 }}<br />
  Nominal working hours: {{ working_hours | floatformat:-1 }}<br />
  Missing hours: {{ missing_hours | floatformat:-1 }}<br />
  Minimum mission days to report: {{ missions2report }}<br />
  Missions reported: <span id="missions_reported">0</span>
</p>

<form action="" method="post" id="import_form">
{% csrf_token %}
<table>
  <thead>
    <tr>
      <th>Report</th>
      <th>Date</th>
      <th>Day of the week</td>
    </tr>
  </thead>
  <tbody>
    {% for month, data in data_by_month.items %}
      <tr>
        <td colspan="4">
          <h4>{{ month | month_num2en }}</h4>
          <p>
            <input type="checkbox" name="rep_{{ month }}_all" id="rep_{{ month }}_all" />
            Total hours: {{ data.tot_hours | floatformat:-1 }} -
            Suggested hours: {{ data.working_hours | floatformat:-1 }} -
            {% if data.missions.all %}
              Suggested minimum missions to report: {{ data.missions2report }}</p>
            {% endif %}
        </td>
      </tr>
      {% if data.missions.all %}
        {% for m in data.missions %}
          <tr>
            <td><input type="checkbox" selected="" name="rep_{{ m.day | date:'m' }}_{{ m.day | date:'d' }}" /></td>
            <td>{{ m.day }}</td>
            <td>{{ m.day | date:'l' }}</td>
          </tr>
        {% endfor %}
      {% endif %}
    {% endfor %}
  </tbody>
</table>
<button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-floppy-save" aria-hidden="true"></span> Continue</button>
</form>

<div id="import_dialog" title="Processing in progress">
    <p>Please wait ...</p>
</div>

<script>
$('#import_dialog').dialog({
  hide: 'slide',
  show: 'slide',
  autoOpen: false,
});

function pad(num, size) {
  num = num.toString();
  while (num.length < size) num = "0" + num;
  return num;
}

$("input:checkbox").change(function() {
  m = $(this).prop('id').match(/rep_(\d+)_all/);
  if (m != null) {
    month = parseInt(m[1])
    if($(this).prop('checked')) {
      $("input[name^='rep_"+pad(month, 2)+"']").each(function() {
        $(this).prop('checked', true);
      });
    } else {
      $("input[name^='rep_"+pad(month, 2)+"']").each(function() {
        $(this).prop('checked', false);
      });
    }
  }
  // Count all checked boxes
  count = 0;
  $("input[name^='rep_']").each(function() {
    m = $(this).prop('name').match(/rep_\d+_\d+/);
    if(m != null && $(this).prop('checked')) {
      count++;
    }
  });
  $("#missions_reported").html(count.toString());
});

$(document).ready(function() {
  $('#import_form').submit(function() {
    $('#import_dialog').dialog('open');
  });
});
</script>

{% endblock %}
